# 狗吠声模版验证方案 (MCU 端全流程)

## 1. 系统架构概览
整个止吠器的狗吠声验证功能，全部在 MCU 上实现，无需后端或额外硬件支持。

**工作流：**
1. **实时监听** → 能量/突发检测（prefilter）
2. **tinyML 裁剪模型** → 精确裁剪出狗吠片段
3. **特征提取**（轻量 embedding）
4. **模版比对**（与注册的狗吠模板相似度对比）
5. **阈值判定** → 是否为注册狗狗 → 控制止吠功能

---

## 2. 注册流程（建立模版库）
用户需要在设备上录制狗吠声，系统自动完成裁剪与模版生成。

1. 用户触发注册模式
2. 录制音频 → 裁剪器提取 **≥3 段狗吠片段**
3. 对每段狗吠：
   - 重采样：16kHz mono
   - 计算 **log-Mel 特征 / MFCC**
   - 输入轻量 CNN → 输出 **32-d embedding**
   - 对 embedding 做 **L2 归一化**
4. 对所有片段的 embedding 取平均 → 得到狗的模版向量
5. 将模版存入本地 Flash (float16 / int8 量化)

### 存储开销
- Embedding: 32 维  
- float16: 64B/狗  
- int8: 32B/狗  
- 即使 50 只狗也只需 <4KB 存储

---

## 3. 运行时流程（实时识别）
MCU 持续监听音频，实时判断是否是注册狗的吠声。

1. **初筛**：能量阈值检测，避免全时推理  
2. **裁剪**：tinyML 裁剪器精确分离狗吠片段  
3. **特征提取**：对裁剪片段提取 embedding（32-d，归一化）  
4. **相似度计算**：与模版库逐一计算余弦相似度  
   - dot = Σ(embedding[i] * template[i])  
   - 模版和 embedding 均归一化 → dot ∈ [-1, 1]  
5. **判定逻辑**：
   - 若相似度 ≥ 阈值 (默认 0.75) → 判定为注册狗
   - 要求 N 次命中（例如 2/3 个窗口内连续命中）才确认
   - 确认后触发止吠动作

---

## 4. 参数推荐
- 音频采样率：16kHz，16-bit PCM  
- 窗口长度：200 ms  
- 窗口步长：100 ms（50% 重叠）  
- 特征：40-d log-Mel  
- Embedding 维度：32  
- 相似度阈值：0.70–0.80（需实测标定）  
- 判定策略：连续 ≥2 个窗口通过判定才触发  

---

## 5. 鲁棒性设计
- **零填充**：不足 200ms 的片段尾部补 0  
- **多段平均**：注册时使用多段平均 embedding，减少偶然噪声影响  
- **内部一致性检查**：若注册样本内部相似度 <0.7 → 提示用户重录  
- **冷却时间**：每次触发后设置 5–30s 的冷却，避免重复动作  
- **动态更新 (可选)**：运行中可使用指数平均更新模版 embedding，增强适应性  

---

## 6. MCU 端实现要点
- **模型格式**：TFLite Micro int8 量化模型  
- **内存优化**：
  - 使用 int8 embedding  
  - 确保 MFCC/log-Mel 提取使用 CMSIS-NN 或手写优化  
- **计算量**：
  - embedding 提取：小型 CNN，几十 KB 参数  
  - 模版匹配：32 MACs/狗，极低负载  

---

## 7. 开发与测试步骤
1. 在 PC 上训练 tinyML CNN，导出 TFLite int8 模型  
2. MCU 上集成：
   - 音频采集 + 缓冲  
   - 裁剪器 (tinyML)  
   - 特征提取 (MFCC/log-Mel)  
   - CNN embedding 推理  
   - 模版存取与相似度计算  
   - 阈值判定与动作控制  
3. 使用真实环境录音进行阈值调参  
4. 确认在目标 MCU 上内存、功耗满足要求  

---

## 8. 总结
- **全部在 MCU 完成**，无需后端  
- **核心方法**：tinyML 裁剪 + CNN embedding + 余弦相似度 + 多段模版平均  
- **优势**：存储小、计算量低、实时性强、鲁棒性可调  
- **下一步**：实测数据集 → 阈值标定 → Flash 模版管理 → 产品集成
